# 3.6 Фильтрация данных. Часть 3

Используемая база данных:

```
+----+-------+--------------------------------------+---------------+
| id | place | trackname                            | artist        |
+----+-------+--------------------------------------+---------------+
| 1  | 4     | You Just Haven't Earned It Yet, Baby | The Smiths    |
| 2  | 3     | Crazy On You                         | Heart         |
| 3  | 2     | Dark Days                            | Theredsunband |
| 4  | 5     | Wish You Were Here                   | The Sounds    |
| 5  | 1     | Let Me Kiss You                      | Morrissey     |
+----+-------+--------------------------------------+---------------+
```



# Метасимволы и оператор LIKE

Операторы сравнения (`=, >, BETWEEN` и другие) позволяют достаточно точно отфильтровать данные, но несколько ограничены в своём функционале, так как выполняют фильтрацию по известным значениям. Если бы нам понадобилось среди множества музыкальных исполнителей отыскать, только тех, название которых начинается с `The`, с помощью обычных операторов мы бы этого сделать не смогли. Здесь нам на помощь приходят оператор `LIKE` и **метасимволы** которые позволяют создавать **шаблоны поиска** и находить значения соответствующие этим шаблонам.

Сами по себе метасимволы являются специальными знаками, которые трактуются языком особым образом. Для того чтобы их использовать в отборе записей, необходимо задействовать оператор `LIKE`, который говорит о том что, следующий шаблон поиска необходимо анализировать с учетом метасимволов, **а не искать точные совпаднеия**.

<kbd>
<div style="display:flex; align-items:center;">
<img src= "../bee.png" alt="пчелыч"  alt="пчелыч" style="width:50px; height:50px; margin-right:20px;">
<p>
Шаблоны поиска представляют собой строки, состоящие из обычных символов, метасимволов или любой их комибнации, поэтому поиск с использованием метасимволов осуществляется только в строковых полях.
</p>
</div>
</kbd>

# Метасимвол %

Наиболее часто используемым метасимволом является знак процента (`%`), который в шаблоне поиска соответстует последовательности любых символов, число символов в последовательности может быть от `0` и более.(Подобный метасимвол используется при составлении регулярных выражений в bash обозначается как знак `*`).

Например, чтобы найти информацию о песнях, название исполнителей которых начинаются с последовательности символов `The`, можно составить шаблон поиска `The%`:

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE artist LIKE 'The%';
```

будет:

```
+--------------------------------------+---------------+
| trackname                            | artist        |
+--------------------------------------+---------------+
| You Just Haven't Earned It Yet, Baby | The Smiths    |
| Dark Days                            | Theredsunband |
| Wish You Were Here                   | The Sounds    |
+--------------------------------------+---------------+
```

В этом запросе при проверке условия следующего после оператора `WHERE`, возвращаются все записи, значения поля `artist`, которые начинаются с последовательности символов `The`. Знак `%` соответствует всем символам идущим после `The` **независимо от их количества**. 

Шаблон `The%` соответствует как строкам `The Smiths` и `The Sound` так и строке `Threredsunband`. Если бы потребовалось получить информацию лишь о тех песнях, название исполнителей которых начинаются с артикля `The`, шаблон поиска было бы необходимо дополнить символом пробела.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE artist LIKE 'The %';
```

будет:

```
+--------------------------------------+------------+
| trackname                            | artist     |
+--------------------------------------+------------+
| You Just Haven't Earned It Yet, Baby | The Smiths |
| Wish You Were Here                   | The Sounds |
+--------------------------------------+------------+
```

Метасимволы могут встречаться в **любом** месте шаблона поиска, в неограниченном количестве. Например с помощью шаблона `%You%` можно отыскать информацию о песнях, название которых включает слово `You`.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE trackname LIKE '%You%';
```

будет:

```
+--------------------------------------+------------+
| trackname                            | artist     |
+--------------------------------------+------------+
| You Just Haven't Earned It Yet, Baby | The Smiths |
| Crazy on You                         | Heart      |
| Wish You Were Here                   | The Sounds |
| Let Me Kiss You                      | Morrissey  |
+--------------------------------------+------------+
```

Таким образом, шаблону `%You%` соответствуют все строки, содержащие текст `You` в любом месте, независимо от количества символов перед указанным текстом и после него. Такому шаблону будут также соответствовать не только строки содержащие слово  `You` но к примеру `Your`, поэтому в этой ситуации верным решением будет указать символ пробела перед и после `You`.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE trackname LIKE '% You %';
```

будет:

```
+--------------------+------------+
| trackname          | artist     |
+--------------------+------------+
| Wish You Were Here | The Sounds |
+--------------------+------------+
```

Теперь шаблон действительно соответствует строкам, которые содержат именно слово `You`, но здесь не учитывается что слово может располагаться и в начале и в конце строки так как требует и слева и справа от слова `You` наличие пробелов. Для поиска необходимого слова независимо от его положения в строке мы можем воспользоватсья дополнительными шаблонами, которые соответствуют упомянутым случаям.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE trackname LIKE 'You %' OR trackname LIKE '% You %' OR trackname LIKE '% You';
```

будет:

```
+--------------------------------------+------------+
| trackname                            | artist     |
+--------------------------------------+------------+
| You Just Haven't Earned It Yet, Baby | The Smiths |
| Crazy on You                         | Heart      |
| Wish You Were Here                   | The Sounds |
| Let Me Kiss You                      | Morrissey  |
+--------------------------------------+------------+
```

# Метасимвол _

Еще одним полезным метасимволом является нижнее подчеркиване (`_`), который в шаблоне поиска соответсвует одному любому символу(В Bash аналогом данного метасимвола являетя знак вопроса `?`). С его помощью можно составить запрос, который поможет отыскать информацию о песнях, названия которых начинаются с какого-либо четырехсимвольного слова.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE trackname LIKE '____ %';
```

будет:

```
+--------------------+---------------+
| trackname          | artist        |
+--------------------+---------------+
| Dark Days          | Theredsunband |
| Wish You Were Here | The Sounds    |
+--------------------+---------------+
```

В шаблоне используются четыре символа `_`, пробел и метасимвол `%` исходя из этого становится понятно что записи в результирующей таблице отфильтрованны по шаблону где к примеру `Dark` это четыре любых символа, затем следует пробел и уже после любое количество символов.

Аналогичным способом можно получить названия песни которые начинаются с какого-либо трёхсимвольного слова.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE trackname LIKE '____ %';
```

будет:

```
+--------------------------------------+------------+
| trackname                            | artist     |
+--------------------------------------+------------+
| You Just Haven't Earned It Yet, Baby | The Smiths |
| Let Me Kiss You                      | Morrissey  |
+--------------------------------------+------------+
```

<kbd>
<div style="display:flex; align-items:center;">
<img src= "../bee.png" alt="пчелыч"  alt="пчелыч" style="width:50px; height:50px; margin-right:20px;">
<p>
В отличии от знака %, который также подразумевает отсутствие символов, знак _ всегда соответствует одному символу - не больше и не меньше
</p>
</div>
</kbd>

# Оператор LIKE BINARY

Важной особенностью оператора `LIKE` является то что при поиске с его помощью строк соответствующих шаблону, не учитвается регистр символов используемых в этом шаблоне. Один из рассмотренных шаблонов можно записать как `%YOU`, `%yoU%, `%you%` и результат останется прежним.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE trackname LIKE '%you%';
```

будет:

```
+--------------------------------------+------------+
| trackname                            | artist     |
+--------------------------------------+------------+
| You Just Haven't Earned It Yet, Baby | The Smiths |
| Crazy on You                         | Heart      |
| Wish You Were Here                   | The Sounds |
| Let Me Kiss You                      | Morrissey  |
+--------------------------------------+------------+
```

В случаях когда регистр важен используется оператор `LIKE BINARY` который делает шаблон поиска **регистрозависимым**.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE trackname LIKE BINARY '%You%';
```

будет:

```
+--------------------------------------+------------+
| trackname                            | artist     |
+--------------------------------------+------------+
| You Just Haven't Earned It Yet, Baby | The Smiths |
| Crazy on You                         | Heart      |
| Wish You Were Here                   | The Sounds |
| Let Me Kiss You                      | Morrissey  |
+--------------------------------------+------------+
```

но при этом результат приведенного ниже запроса будет пуст:

```
SELECT trackname, artist
FROM Songs
WHERE trackname LIKE BINARY '%you%';
```

#### Примечание 1.

Метасимволы - очень мощный механизм, но за эту мощность всегда приходится платить, так как на поиск с использованием метасимволов **уходит больше времени**, чем на любые другие виды поиска. Поэтому в случае если можно обойтись без метасимволов, лучше обойтись без них не создавая лишнюю нагрузку и не увеличения времени обработки запроса.

#### Примечание 2.

Метасимволы в шаблоне поиска соответствуют набору символов или одному любому символу, однако в случае если понадобится отыскать совпадение только для самого метасимвола, например символа процента (`%`). В подобных случаях используется экранирование с помощью оператора `ESCAPE`, который указывается после шаблона поиска и определяет символ, отвечающий за экранирование. 

Например, условие поиска значений вида `10%`, `24%` `49%` и так далее может выглядеть следующим образом:

```
WHERE <название поля> LIKE '__/%' ESCAPE '/';
```

Здесь для экранирования используется прямой слэш (`/`), который в шаблоне указывает на то, что символ стоящий после слэеша не стоит рассматривать как метасимвол.

#### Примечание 3. 

Метасимвол `%` может соответствовать чему угодно, но есть одно исключение: `NULL`. Никакой шаблон поиска не позволит отобрать запись, проверяемое поле которой содержит значение `NULL`.

#### Примечание 4.

При составлении шаблона поиска, с помощью которого планируется выполнять поиск строк типа `CHAR`, необходимо помнить, что этот тип данных заполняет пробелами неиспользуемую часть строки. Если не учитывать в шаблоне **потенциальные пробелы**, поиск может выполняться неверно.

---