# 3.4 Фильтрация данных. Часть 1

Используемая база данных:

```
+----+-------+----------------------+------------+---------+--------------+
| id | place | trackname            | artist     | streams | release_date |
+----+-------+----------------------+------------+---------+--------------+
| 1  | 4     | Crazy On You         | Heart      | 76338   | NULL         |
| 2  | 3     | My Lover             | The Sounds | 99488   | NULL         |
| 3  | 2     | Running up That Hill | Kate Bush  | 121495  | 1985-08-05   |
| 4  | 5     | Thrill               | The Sounds | 49345   | 2016-11-10   |
| 5  | 1     | Spent the Day in Bed | Morrissey  | 174994  | 2017-09-19   |
+----+-------+----------------------+------------+---------+--------------+
```

# Оператор WHERE

Для извлечения некоторой части информации из баз данных используется оператор `WHERE`, который позволяет указывать определенные условия при извлечении записей. Если запись удовлетворяет этим условиям, она попадает в результирующую таблицу, в противном случае отбрасывается. 

В качестве примера, запрос который извлекает данные о песнях конкретного исполнителя:

```
SELECT *
FROM Songs
WHERE artist = 'The Sounds';
```

Результатом будет:

```
+----+----------+-----------+------------+---------+--------------+
| id | place    | trackname | artist     | streams | release_date |
+----+----------+-----------+------------+---------+--------------+
| 2  | 3        | My Lover  | The Sounds | 99488   | NULL         |
| 4  | 5        | Thrill    | The Sounds | 49345   | 2016-11-10   |
+----+----------+-----------+------------+---------+--------------+
```

В данном примере используется простая проверка на равенство. Запрос извлекает все поля таблицы, но возвращает не все записи, а только те поля `artist`, которые равны `The Sounds`.

Оператор `WHERE` указывается после названия таблицы. Оператор `WHERE` может совместно использоваться с оператором `ORDER BY`, в таком случае оператор `ORDER BY`, должен распологаться после оператора `WHERE`.

Результатом запроса:

```
SELECT *
FROM Songs
WHERE artist = 'The Sounds'
ORDER BY streams;
```

будет:

```
+----+----------+-----------+------------+---------+--------------+
| id | place    | trackname | artist     | streams | release_date |
+----+----------+-----------+------------+---------+--------------+
| 4  | 5        | Thrill    | The Sounds | 49345   | 2016-11-10   |
| 2  | 3        | My Lover  | The Sounds | 99488   | NULL         |
+----+----------+-----------+------------+---------+--------------+
```

# Операторы сравнения

Условия после оператора `WHERE` может являться не только проверкой на равенство. В SQL поддерживается целый набор операторов сравнения, которые перечислены в таблице:

|       Оператор      |        Проверка        |
|---------------------|------------------------|
| `=`                 | Равенство              |
| `<=>`               | Эквивалентность        |
| `!=` или `<>`       | Неравенство            |
| `<`                 | Меньше                 |
| `<=`                | Меньше или равно       |
| `>`                 | Больше                 |
| `>=`                | Больше или равно       |
| `BETWEEN`           | Вхождение в диапазон   |
| `IS NULL`           | Значение `NULL`        |
| `IS NOT NULL`       | Не значение `NULL`     |

Теперь попробуем воспользоваться другими операторами сравнения.

# Сравнение с одиночным значением

**Пример 1.** Извлечем из таблицы `Songs` данные о песнях, количество прослушиваний которых превышает `100000`.

Результатом запроса:

```
SELECT trackname, artist, streams
FROM Songs
WHERE streams > 100000;
```

будет:

```
+----------------------+-----------+---------+
| trackname            | artist    | streams |
+----------------------+-----------+---------+
| Running up That Hill | Kate Bush | 121495  |
| Spent the Day in Bed | Morrissey | 174994  |
+----------------------+-----------+---------+
```

**Пример 2.** Извлечем из таблицы `Songs` данные о песнях, которые входят в тройку лучших композиций, и отсортируем их по занимаемой позиции.

Результатом запроса:

```
SELECT place, trackname, artist
FROM Songs
WHERE place <= 3
ORDER BY place;
```

будет:

```
+----------+----------------------+------------+
| place    | trackname            | artist     |
+----------+----------------------+------------+
| 1        | Spent the Day in Bed | Morrissey  |
| 2        | Running up That Hill | Kate Bush  |
| 3        | My Lover             | The Sounds |
+----------+----------------------+------------+
```

**Пример 3.** Извлечем из таблицы `Songs` данные о песнях, которые не принадлежат группе `The Sounds`.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE artist != 'The Sounds';
```

будет:

```
+----------------------+-----------+
| trackname            | artist    |
+----------------------+-----------+
| Crazy on You         | Heart     |
| Running up That Hill | Kate Bush |
| Spent the Day in Bed | Morrissey |
+----------------------+-----------+
```

<kbd>
<div style="display:flex; align-items:center;">
<img src= "../bee.png" alt="пчелыч"  alt="пчелыч" style="width:50px; height:50px; margin-right:20px;">
<p>
Операторы != и <> обычно взаимозаменяемы, однако не во всех СУБД поддерживаются обе формы оператора.
</p>
</div>
</kbd>

# Сравнение с диапазоном значений

Для сравнения с диапазоном значений используется оператор `BETWEEN`. Его синтаксис немного отличается от других операторов, так как для него требуется два значения, начальное и конечное.

**Пример 1.** Извлечем из таблицы Songs данные о песнях, количество прослушиваний которых находится в диапазоне `[50000; 100000]`.

Результатом запроса:

```
SELECT trackname, artist, streams
FROM Songs
WHERE streams BETWEEN 50000 AND 100000;
```

будет:

```
+--------------+------------+---------+
| trackname    | artist     | streams |
+--------------+------------+---------+
| Crazy on You | Heart      | 76338   |
| My Lover     | The Sounds | 99488   |
+--------------+------------+---------+
```

При использовании оператора `BETWEEN` нужно указывать два значения: нижнюю и верхнюю границы диапазона. Оба значения должны быть разделены ключевым словом `AND`. При этом извлекаются все значения из диапазона, включая те, что равны граничным значениям.

**Пример 2.** Извлечем из таблицы `Songs` данные о песнях, которые занимают второе, третье и четвертое места, и отсортируем их по занимаемой позиции.

Результатом запроса:

```
SELECT place, trackname, artist
FROM Songs
WHERE place BETWEEN 2 AND 4
ORDER BY place;
```

будет:

```
+----------+----------------------+------------+
| place    | trackname            | artist     |
+----------+----------------------+------------+
| 2        | Running up That Hill | Kate Bush  |
| 3        | My Lover             | The Sounds |
| 4        | Crazy on You         | Heart      |
+----------+----------------------+------------+
```

# Проверка на присутствие и отсутствие значения 

Чтобы проверить содержит ли поле `NULL`, нельзя просто записать `<название_поля> = NULL`, поскольку значение `NULL` трактуется как неопределенное, и мы не можем выполнить проверку такого значения ни на равенство, ни на не равенство.

Для определения того, находится ли в поле значение `NULL`, предусмотрен оператор `IS NULL`. Противоположным для него оператором является `IS NOT NULL`, который позволяет определить, что в поле **не находится** значение `NULL`.

**Пример 1.** Извлечем из таблицы `Songs` данные о песнях, которые не имеют даты выхода.

Результатом запроса:

```
SELECT trackname, artist, release_date
FROM Songs
WHERE release_date IS NULL;
```

будет:

```
+--------------+------------+--------------+
| trackname    | artist     | release_date |
+--------------+------------+--------------+
| Crazy on You | Heart      | NULL         |
| My Lover     | The Sounds | NULL         |
+--------------+------------+--------------+
```

**Пример 2.** Извлечем из таблицы `Songs` данные о песнях, которые имеют дату выхода, и отсортируем их по этой дате в порядке убывания.

Результатом запроса:

```
SELECT trackname, artist, release_date
FROM Songs
WHERE release_date IS NOT NULL
ORDER BY release_date DESC;
```

будет:

```
+----------------------+------------+--------------+
| trackname            | artist     | release_date |
+----------------------+------------+--------------+
| Spent the Day in Bed | Morrissey  | 2017-09-19   |
| Thrill               | The Sounds | 2016-11-10   |
| Running up That Hill | Kate Bush  | 1985-08-05   |
+----------------------+------------+--------------+
```

#### Примечание 1.

Псевдонимы не могут быть использованы в блоке оператора `WHERE` для фильтрации записей.

Результатом запроса:

```
​SELECT trackname, artist, streams AS auditions
FROM Songs
WHERE auditions > 100000;
```

будет ошибка:

```
ERROR 1054: Unknown column 'auditions' in 'where clause'
```

Это связано с тем что блок `WHERE` обрабатывается до блока `SELECT`, поэтому на момент выполнения блока `WHERE` псевдонимы полей еще неизвестны.

#### Примечание 2.

В зависимости от оператора и сравниваемых значений результатом операции сравнения могут являться следующие значения:

- `1` - эквивалентно истине;
- `0` - эквивалентно лжи;
- `NULL` - эквивалентно неопределенности;

Результатом запроса:

```
SELECT 'x' = 'x',
       'x' <=> 'x',
       'x' <=> 'y',
       'x' != 'z',
       5 < 10,
       10 <= 10,
       5 > 10,
       10 >= 5;
```

будет:

```
+-----------+-------------+-------------+------------+--------+----------+--------+---------+
| 'x' = 'x' | 'x' <=> 'x' | 'x' <=> 'y' | 'x' != 'z' | 5 < 10 | 10 <= 10 | 5 > 10 | 10 >= 5 |
+-----------+-------------+-------------+------------+--------+----------+--------+---------+
| 1         | 1           | 0           | 1          | 1      | 1        | 0      | 1       |
+-----------+-------------+-------------+------------+--------+----------+--------+---------+
```

Результат сравнения любого значения с `NULL` является `NULL`.

Результатом запроса:

```
SELECT 'x' != NULL,
       10 > NULL,
       NULL = NULL;
```

будет:

```
+-------------+-----------+-------------+
| 'x' != NULL | 10 > NULL | NULL = NULL |
+-------------+-----------+-------------+
| NULL        | NULL      | NULL        |
+-------------+-----------+-------------+
```

Исключением является оператор эквивалентности, который аналогичен оператору равенства лишь с той разницей, что результат будет равен `1` в случае сравнения `NULL` с `NULL` и `0`, когда идет сравнение любого отличного от `NULL` значения с `NULL`.

Результатом запроса:

```
SELECT 'x' <=> NULL,
       '5' <=> NULL,
       NULL <=> NULL;
```

будет:

```
+--------------+--------------+---------------+
| 'x' <=> NULL | '5' <=> NULL | NULL <=> NULL |
+--------------+--------------+---------------+
| 0            | 0            | 1             |
+--------------+--------------+---------------+
```

#### Примечание 3. 

По умолчанию операторы сравнения не учитывают регистр при сравнении строковых значений. 

Результатом запроса:

```
SELECT 'bee' = 'Bee',
       'bee' <=> 'Bee',
       'bee' > 'Bee',
       'bee' < 'Bee';
```

будет:

```
+---------------+-----------------+---------------+---------------+
| 'bee' = 'Bee' | 'bee' <=> 'Bee' | 'bee' > 'Bee' | 'bee' < 'Bee' |
+---------------+-----------------+---------------+---------------+
| 1             | 1               | 0             | 0             |
+---------------+-----------------+---------------+---------------+
```

#### Примечание 4.

Оператор `LIMIT` при его использовании совместно с оператором `WHERE` или сочетанием `WHERE` и `ORDER BY` должен распологаться после них.

Результатом запроса:

```
SELECT place, trackname, artist
FROM Songs
WHERE place <= 4
LIMIT 2;
```

будет:

```
+-------+--------------+------------+
| place | trackname    | artist     |
+-------+--------------+------------+
| 4     | Crazy on You | Heart      |
| 3     | My Lover     | The Sounds |
+-------+--------------+------------+
```

Это связано с порядком, в котором запрос выполняет свои операции:

- сначала извлекает из таблицы записи, удовлетворяющие заданным условиям;
- затем сортирует;
- только после этого ограничивает определенным количеством;

---