# 3.5 Фильтрация данных. Часть 2

Используемая база данных:

```
+----+----------+----------------------+------------+---------+--------------+
| id | place    | trackname            | artist     | streams | release_date |
+----+----------+----------------------+------------+---------+--------------+
| 1  | 4        | Crazy On You         | Heart      | 76338   | 1976-03-01   |
| 2  | 3        | My Lover             | The Sounds | 99488   | 2009-05-31   |
| 3  | 2        | Running up That Hill | Kate Bush  | 121495  | 1985-08-05   |
| 4  | 5        | Thrill               | The Sounds | 49345   | 2016-11-10   |
| 5  | 1        | Spent the Day in Bed | Morrissey  | 174994  | 2017-09-19   |
+----+----------+----------------------+------------+---------+--------------+
```

# Операторы AND и OR

В SQL как и во многих других языках программирования, можно использовать несколько условий чтобы создавать сложные фильтры. Для этого предназначены логические операторы `AND` и `OR`.

# Оператор AND

Чтобы отфильтровать данные по нескольким полям, необходимо воспользоваться оператором `AND`. Он используется для извлечения тех записей, которые удовлетворяют **всем** указанным условиям.

Результатом запроса:

```
SELECT trackname, artist, streams, release_date
FROM Songs
WHERE streams > 50000 AND release_date >= '2000-01-01';
```

будет:

```
+----------------------+------------+---------+--------------+
| trackname            | artist     | streams | release_date |
+----------------------+------------+---------+--------------+
| My Lover             | The Sounds | 99488   | 2009-05-31   |
| Spent the Day in Bed | Morrissey  | 174994  | 2017-09-19   |
+----------------------+------------+---------+--------------+
```

Здесь извлекаются данные о тех песнях что были прослушаны `streams` больше `50000` раз и дата выхода больше или равна `2000-01-01`. После оператора `WHERE` содержатся два условия, оператор `AND` используется для их объединения. Оператор `AND` говорит что должны быть возвращены только те записи, которые соответствуют двум условиям.

<kbd>
<div style="display:flex; align-items:center;">
<img src= "../bee.png" alt="пчелыч"  alt="пчелыч" style="width:50px; height:50px; margin-right:20px;">
<p>
Количество условий оператора WHERE может быть больше двух, в таком случае каждое из них должно отделяться отдельным оператором AND.
</p>
</div>
</kbd>

# Оператор OR

Действия оператора `OR` противоположны оператору `AND`, вместо того чтобы извлекать данные соответствующие нескольким условиям, оператор `OR` позволяет выводить результат если **хотя бы одно** из условий будет выполнено.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE artist = 'Heart' OR artist = 'Kate Bush';
```

будет:

```
+----------------------+-----------+
| trackname            | artist    |
+----------------------+-----------+
| Crazy On You         | Heart     |
| Running up That Hill | Kate Bush |
+----------------------+-----------+
```

В этом запросе извлекаются данные о песнях исполнителями которых являются `Heart` и `Kate Bush`

<kbd>
<div style="display:flex; align-items:center;">
<img src= "../bee.png" alt="пчелыч"  alt="пчелыч" style="width:50px; height:50px; margin-right:20px;">
<p>
В большинстве СУБД при использовании оператора OR второе условие не рассматривается, если выполняется первое. 
</p>
</div>
</kbd>

# Порядок обработки операторов

После оператора `WHERE` может содержаться любое количество логических операторов `AND` или `OR`. Однако стоит учитывать что оператор `AND` обрабатывается первым при комбинировании операторов `AND` и `OR`.

Результатом запроса:

```
SELECT trackname, artist, streams
FROM Songs
WHERE artist = 'The Sounds' OR artist = 'Kate Bush' AND streams > 50000;
```

будет:

```
+----------------------+------------+---------+
| trackname            | artist     | streams |
+----------------------+------------+---------+
| My Lover             | The Sounds | 99488   |
| Running up That Hill | Kate Bush  | 121495  |
| Thrill               | The Sounds | 49345   |
+----------------------+------------+---------+
```

Судя по результирующей таблице, записи были отфильтрованны не так как следует по условию. Так количество прослушиваний в результирующей таблице не превышает `50000`.

Чтобы составить корректный запрос, учитывающий все условия необходимо воспользоваться скобками и точно сгруппировать необходимые условия. В нашем случае в скобки нужно заключить часть условия с оператором `OR`, чтобы она имела больший приоритет и выполнялась первой.

Результатом запроса:

```
SELECT trackname, artist, streams
FROM Songs
WHERE (artist = 'The Sounds' OR artist = 'Kate Bush') AND streams > 50000;
```

будет:

```
+----------------------+------------+---------+
| trackname            | artist     | streams |
+----------------------+------------+---------+
| My Lover             | The Sounds | 99488   |
| Running up That Hill | Kate Bush  | 121495  |
+----------------------+------------+---------+
```

Теперь при извлечении **сначала** проверяется поле `artist` на предмет наличия `The Sounds` или `Kate Bush` а затем выполняется проверка на то больше ли `50000` поле `streams`.

<kbd>
<div style="display:flex; align-items:center;">
<img src= "../bee.png" alt="пчелыч"  alt="пчелыч" style="width:50px; height:50px; margin-right:20px;">
<p>
При использовании логических операторов AND и OR рекомендуется всегда ставить скобки, чтобы точно сгруппировать условия. Не стоит полагаться на порядок обработки по умолчанию, даже если он подразумевает необходимый результат.
</p>
</div>
</kbd>

# Оператор IN

Оператор `IN` позволяет определить, совпадает ли значение в поле с одним из перечисленных.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE artist IN ('Heart', 'Kate Bush', 'Morrissey');
```

будет:

```
+----------------------+-----------+
| trackname            | artist    |
+----------------------+-----------+
| Crazy on You         | Heart     |
| Running up That Hill | Kate Bush |
| Spent the Day in Bed | Morrissey |
+----------------------+-----------+
```

Данный запрос извлекает данные о тех песнях, исполнителями которых являются `Heart`, `Kate Bush` и `Morrissey`. Оператор `IN` похож на оператор `OR`, приведенный ниже запрос с использованием `OR` равносилен использованию `IN`:

```
SELECT trackname, artist
FROM Songs
WHERE artist = 'Heart' OR artist = 'Kate Bush' OR artist = 'Morrissey';
```

Но оператор `IN` имеет некоторое преимущество переде оператором `OR`. При работе с большим количеством значений синтаксис оператора `IN` гораздо понятнее. Также при использовании оператора `IN` совместно с операторами `AND` и `OR` намного легче управлять порядком их обработки.

# Оператор NOT

Оператор `NOT` служит только одной цели - отрицать условия следующие за ним. С помощью данного оператора мы можем извлечь данные о тех песнях, исполнителями которых **не является** группа `The Sounds`.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE NOT artist = 'The Sounds';
```

будет:

```
+----------------------+-----------+
| trackname            | artist    |
+----------------------+-----------+
| Crazy on You         | Heart     |
| Running up That Hill | Kate Bush |
| Spent the Day in Bed | Morrissey |
+----------------------+-----------+
```

В данном случае можно и обойтись без оператора `NOT` составив запрос воспользовавшись лишь оператором сравнения `!=`.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE artist != 'The Sounds';
```

будет:

```
+----------------------+-----------+
| trackname            | artist    |
+----------------------+-----------+
| Crazy on You         | Heart     |
| Running up That Hill | Kate Bush |
| Spent the Day in Bed | Morrissey |
+----------------------+-----------+
```

Но в более сложных условиях можно воспользоваться оператором `NOT` в связке с оператором `IN`, что окажется предпочтительнее оператора `!=`.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE NOT artist IN ('Heart', 'Kate Bush', 'Morrissey');
```

будет:

```
+-----------+------------+
| trackname | artist     |
+-----------+------------+
| My Lover  | The Sounds |
| Thrill    | The Sounds |
+-----------+------------+
```

В этом запросе извлекаются данные о тех песнях, авторами которых **не являются** `Heart`, `Kate Bush`, `Morrissey`. Аналогичный запрос с использованием `!=` выглядел бы следующим образом:

```
SELECT trackname, artist
FROM Songs
WHERE artist != 'Heart' AND artist != 'Kate Bush' AND artist != 'Morrissey';
```

# Оператор NOT IN

Связка операторов `NOT`, `IN` довольно полезна но недостаточно наглядна. На практике для определения несоответствий списку значений требуется более очевидный оператор `NOT IN`, выполняющий ровно то же что и связка операторов `NOT` и `IN`.

Результатом запроса:

```
SELECT trackname, artist
FROM Songs
WHERE artist NOT IN ('Heart', 'Kate Bush', 'Morrissey');
```

будет:

```
+-----------+------------+
| trackname | artist     |
+-----------+------------+
| My Lover  | The Sounds |
| Thrill    | The Sounds |
+-----------+------------+
```

#### Примечание 1.

Логические операторы `AND`, `OR`, `NOT`, `IN` и `NOT IN` имеют разный приоритет обработки. В таблице ниже они представлены в **порядке уменьшения их приоритета**:

|    Оператор    |
|----------------|
| `IN`, `NOT IN` |
|     `NOT`      |
|     `AND`      |
|     `OR`       |

**Если условие содержит несколько логических операторов с одинаковым приоритетом, они выполняются слева направо.**

#### Примечание 2.

Оператор `NOT` отрицает только те условия, перед которыми он указан:

Результатом запроса:

```
SELECT id, artist
FROM Songs
WHERE NOT id = 1 OR id = 2;
```

будет:

```
+----+------------+
| id | artist     |
+----+------------+
| 2  | The Sounds |
| 3  | Kate Bush  |
| 4  | The Sounds |
| 5  | Morrissey  |
+----+------------+
```

В запросе указано два условия, но оператор `NOT` отрицает только первое из них. Для того чтобы он отрицал все условия, необходимо объединить их с помощью круглых скобок:

```
SELECT id, artist
FROM Songs
WHERE NOT (id = 1 OR id = 2);
```

и таким образом результатом будет:

```
+----+------------+
| id | artist     |
+----+------------+
| 3  | Kate Bush  |
| 4  | The Sounds |
| 5  | Morrissey  |
+----+------------+
```

---